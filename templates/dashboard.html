{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}

<div class="container mt-4">
  <h2 class="text-center">Dashboard</h2>

  <!-- Display Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- ‚ùñ Stats Cards -->
  <div class="row text-center mb-4">
    <div class="col-md-4 mb-2">
      <div class="card text-white mb-4" style="background-color: #f4a261;">
        <div class="card-body">
          <h6><i class="fas fa-wallet"></i> Total Balance</h6>
          <h3>ZAR {{ "%.2f"|format(user.balance) }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-2">
      <div class="card text-white mb-4" style="background-color: #2a9d8f;">
        <div class="card-body">
          <h6><i class="fas fa-user-friends"></i> Your Beneficiaries</h6>
          <h3>{{ beneficiaries|length }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-2">
      <div class="card text-white mb-4" style="background-color: #e76f51;">
        <div class="card-body">
          <h6><i class="fas fa-exchange-alt"></i> Transactions</h6>
          <h3>{{ transactions|length }}</h3>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ùñ Welcome & Account Info -->
  <p><strong>Welcome, {{ user.username }}!</strong></p>
  <p>Your account number: <strong>{{ user.account_number }}</strong></p>
  <p><strong>Account Status:</strong> <span class="badge bg-success">Verified</span></p>

  <!-- ‚ùñ Live Exchange Rates -->
  <h3>Live Exchange Rate</h3>
  <p>
    <strong>1 ZAR = </strong>
    <span id="exchange_rate" class="flashing">Fetching...</span>
    <strong id="selected_currency">USD</strong>
    @ <span id="rate_timestamp"></span>
  </p>

  <!-- ‚ùñ Deposit Funds -->
  <h3>Deposit ZAR</h3>
  <form method="post" action="{{ url_for('deposit') }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <div class="input-group mb-3">
      <input type="number" name="amount" step="0.01" class="form-control" placeholder="Enter ZAR Amount" required>
      <button type="submit" class="btn btn-success">Confirm Deposit</button>
    </div>
  </form>

  <!-- ‚ùñ Quick Conversion Preview -->
  <h3>Quick Conversion Preview</h3>
  <form id="convertForm" class="row g-2 mb-4">
    <div class="col-sm-4">
      <input type="number" step="0.01" name="amount" class="form-control" placeholder="ZAR Amount" required>
    </div>
    <div class="col-sm-4">
      <select name="currency" class="form-select">
        <option value="USD">USD</option>
        <option value="EUR">EUR</option>
        <option value="GBP">GBP</option>
        <option value="BWP">BWP</option>
        <option value="CNY">CNY</option>
      </select>
    </div>
    <div class="col-sm-4">
      <button type="submit" class="btn btn-outline-primary w-100">Preview</button>
    </div>
  </form>
  <div id="previewResult" class="mb-4"></div>

<!-- ‚ùñ How It Works -->
<h3>How it Works</h3>
<p>
  <strong>iTradeAfrika¬Æ</strong> enables instant cross‚Äëborder transfers using crypto.
  Deposit ZAR into our Capitec Business Account
  <strong>(1052923917, Branch Code: 450105, SWIFT: CABLZAJJ)</strong>
  with your account number as reference.
</p>
<p>
  We convert at the best rate, apply a 10% fee, and send USD/BWP/EUR/GBP/CNY
  to your beneficiary within hours once we have received proof of payment and deposits.
</p>

<!-- ‚ùñ Disclaimers & Security Reminders -->
<div class="alert alert-warning" role="alert">
  ‚ö†Ô∏è <strong>Disclaimer:</strong> iTradeAfrika¬Æ operates under FSCA guidelines. We do not provide investment advice. Cryptocurrency transactions are subject to market risk. Always verify beneficiary details before initiating transfers. Transactions are processed only once we have received proof of payment and deposits.
</div>

<div class="alert alert-info" role="alert">
  üîí <strong>Security Reminder:</strong> Never share your account credentials with anyone. Always log out after using the platform.
</div>

<div class="alert alert-secondary" role="alert">
  ‚úÖ <strong>Verification Notice:</strong> Only verified accounts can send or receive funds. Please complete KYC to enable full platform functionality. Transfers are processed only after deposit verification.
</div>

<!-- ‚ùñ Need Help Card -->
<div class="card text-white mb-4" style="background-color: #1e3d59;">
  <div class="card-body">
    <h5 class="card-title">Need Help?</h5>
    <p class="card-text">
      üìß Email us at <a href="mailto:itradeafrika@gmail.com" class="text-white">itradeafrika@gmail.com</a><br>
      üì± WhatsApp/Call: <strong>073 916 1782</strong>
    </p>
    <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">Logout</a>
  </div>
</div>


  <!-- Navigation Buttons -->
  <a href="{{ url_for('add_beneficiary') }}" class="btn btn-success me-2">Add Beneficiary</a>
  <a href="{{ url_for('send_money') }}" class="btn btn-primary">Send Money</a>

  <!-- ‚ùñ Transaction History -->
  <h3 class="mt-4">Transaction History</h3>
  <table class="table table-bordered">
    <thead>
      <tr>
        <th>Date</th><th>Type</th><th>Amount (ZAR)</th>
        <th>Final Payout</th><th>Currency</th><th>Status</th>
        <th>Purpose</th><th>Reference</th>
      </tr>
    </thead>
    <tbody>
      {% for txn in transactions %}
      <tr>
        <td>{{ txn.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
        <td>
          {% if txn.transaction_type == "Deposit" %}
            Deposit
          {% else %}
            Payment to {{ txn.beneficiary.name if txn.beneficiary else "N/A" }}
          {% endif %}
        </td>
        <td>ZAR {{ "%.2f"|format(txn.amount) }}</td>
        <td>{{ "%.2f"|format(txn.final_amount or 0) }} {{ txn.currency }}</td>
        <td>{{ txn.currency }}</td>
        <td>
          {% if txn.status == "Pending" %}
            <span class="badge bg-warning">Pending</span>
          {% elif txn.status == "Success" %}
            <span class="badge bg-success">Success</span>
          {% else %}
            <span class="badge bg-danger">Failed</span>
          {% endif %}
        </td>
        <td>{{ txn.purpose or '-' }}</td>
        <td>{{ txn.reference or '-' }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- JavaScript for Live Rates & Conversion Preview -->
<script>
function updateExchangeRate() {
  fetch('/get_live_rates')
    .then(r => r.json())
    .then(data => {
      if (!data.error) {
        document.getElementById("exchange_rate").innerText = data.exchange_rate;
        document.getElementById("selected_currency").innerText = data.selected_currency;
        document.getElementById("rate_timestamp").innerText = data.timestamp || '';
        const el = document.getElementById("exchange_rate");
        el.classList.add("flash");
        setTimeout(() => el.classList.remove("flash"), 500);
      }
    });
}
setInterval(updateExchangeRate, 10000);
updateExchangeRate();

document.getElementById("convertForm").addEventListener("submit", e => {
  e.preventDefault();
  const params = new URLSearchParams(new FormData(e.target));
  fetch(`/get_conversion_preview?${params}`)
    .then(r => r.json())
    .then(data => {
      if (data.error) {
        alert(data.error);
      } else {
        document.getElementById("previewResult").innerHTML = `
          <p>Entered: ZAR ${data.amount_entered.toFixed(2)}</p>
          <p>After fees: ZAR ${data.amount_after_fees.toFixed(2)}</p>
          <p>Payout: ${data.final_payout.toFixed(2)} ${data.payout_currency}</p>
        `;
      }
    });
});
</script>

<style>
@keyframes flash {
    0%, 100% { background-color: gold; }
    50% { background-color: transparent; }
}
.flash {
    animation: flash 0.5s ease-in-out;
}
</style>

{% endblock %}
