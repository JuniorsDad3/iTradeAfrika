{% extends "base.html" %}
{% block title %}Send Money{% endblock %}
{% block content %}

<div class="container mt-5">
  <div class="card p-4 shadow-sm">
    <h2 class="mb-3 text-center">Send Money</h2>

    <p class="text-center">
      <strong>Your Balance:</strong> ZAR {{ "%.2f"|format(user.balance) }}
    </p>

    <form method="POST" action="{{ url_for('send_money') }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

      <div class="mb-3">
        <label for="amount" class="form-label">Amount to Send (ZAR)</label>
        <input type="number" step="0.01" name="amount" id="amount" class="form-control" placeholder="Enter amount in ZAR" required>
      </div>

      <div class="mb-4">
        <label for="beneficiary_id" class="form-label">Select Beneficiary</label>
<select name="beneficiary_id" id="beneficiary_id" class="form-select" required>
  <option disabled selected value="">-- Choose a Beneficiary --</option>
  {% for b in beneficiaries %}
    <option value="{{ b.id }}" data-currency="{{ b.currency }}">
      {{ b.full_name }} â€“ {{ b.account_number }} ({{ b.currency }})
    </option>
  {% endfor %}
        </select>
      </div>

      <!-- Live Transaction Preview -->
      <div class="bg-light p-3 rounded border mb-3">
        <h5 class="mb-2">ðŸ’¡ Transaction Preview</h5>
        <p><strong>Amount Entered:</strong> ZAR <span id="amountEntered">0.00</span></p>
        <p><strong>After 10% Fee:</strong> ZAR <span id="amountAfterFees">0.00</span></p>
        <p><strong>Final Payout:</strong> <span id="finalPayout">0.00</span> <span id="payoutCurrency">---</span></p>
      </div>

      <div class="text-end">
        <button type="submit" class="btn btn-primary btn-lg">Send Money</button>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const amountInput = document.getElementById("amount");
  const beneficiarySelect = document.getElementById("beneficiary_id");

  function updatePreview() {
    let amountZAR = parseFloat(amountInput.value) || 0;
    let selected = beneficiarySelect.options[beneficiarySelect.selectedIndex];
    let currency = selected ? selected.getAttribute("data-currency") : null;

    if (amountZAR > 0 && currency) {
      fetch(`/get_conversion_preview?amount=${amountZAR}&currency=${currency}`)
        .then(res => res.json())
        .then(data => {
          if (!data.error) {
            document.getElementById("amountEntered").textContent = data.amount_entered.toFixed(2);
            document.getElementById("amountAfterFees").textContent = data.amount_after_fees.toFixed(2);
            document.getElementById("finalPayout").textContent = data.final_payout.toFixed(2);
            document.getElementById("payoutCurrency").textContent = data.payout_currency;
          }
        })
        .catch(err => console.error("Preview error:", err));
    } else {
      document.getElementById("amountEntered").textContent = "0.00";
      document.getElementById("amountAfterFees").textContent = "0.00";
      document.getElementById("finalPayout").textContent = "0.00";
      document.getElementById("payoutCurrency").textContent = "---";
    }
  }

  amountInput.addEventListener("input", updatePreview);
  beneficiarySelect.addEventListener("change", updatePreview);
});
</script>

{% endblock %}
